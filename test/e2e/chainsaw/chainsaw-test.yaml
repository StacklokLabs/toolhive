apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: toolhive-operator-basic
spec:
  description: Basic E2E test for ToolHive Operator
  timeouts:
    apply: 30s
    assert: 60s
    cleanup: 30s
    exec: 300s
  steps:
  # Step 1: Setup ToolHive Operator using task
  - name: setup-crd
    description: Setup ToolHive Operator using task command
    try:
    - command:
        entrypoint: task
        args:
        - operator-install-crds
    - assert:
        file: 01-assert-crd.yaml

  - name: setup-operator
    description: Setup ToolHive Operator using task command
    try:
    - command:
        entrypoint: task
        args:
        - operator-deploy-local
    - assert:
        file: 02-assert-operator-ready.yaml
      
  - name: deploy-mcpserver
    description: Deploy a basic MCPServer instance and verify it's ready
    try:
    - apply:
        file: 03-mcpserver.yaml
    - assert:
        file: 03-mcpserver.yaml
    - assert:
        file: 03-assert-mcpserver-running.yaml
    - assert:
        file: 03-assert-mcpserver-proxy-runner-running.yaml
    - assert:
        file: 03-assert-mcpserver-proxy-runner-svc.yaml
    - assert:
        file: 03-assert-mcpserver-pod-running.yaml
        
  # Step 4: Verify MCPServer status and cleanup
  - name: verify-and-cleanup
    description: Verify MCPServer is running and clean up
    try:
    - assert:
        file: 03-assert-mcpserver-running.yaml
    finally:
    - delete:
        ref:
          apiVersion: toolhive.stacklok.dev/v1alpha1
          kind: MCPServer
          name: test-fetch
          namespace: default